<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Elle #2</title>
	<script src="//www.marvinj.org/releases/marvinj-1.0.js"></script>
	<style>
		html, body {
			margin: 0;
			padding: 0;
			height: 100%;
			background: black;
			overflow: hidden;
			display: flex;
			align-items: center;
			justify-content: center;
			flex-direction: column;
		}
		canvas {
		}
	</style>
</head>
<body>
	<canvas id="cvs"></canvas>
	<script type="text/javascript">
		MarvinImage.prototype.getIntColorArray = function(x,y){
			const start = (y * this.width + x) * 4;
			return this.imageData.data.slice(start, start + 4);
		};

		function randint(n) {
			return Math.round(Math.random() * n)
		}

		function draw() {
			while (true) {
				const x = randint(img.width - 20) + 10;
				const y = randint(img.height - 20) + 10;
				const c = imgBlur.getIntComponent0(x, y);
				if (c / 255 < Math.random()) continue;
				size = (c / 255) * 5 + 1

				ctx.beginPath();
				const [r, g, b, a] = img.getIntColorArray(x, y);
				ctx.fillStyle = `rgb(${r}, ${g}, ${b})`;
				ctx.arc(x, y, size, 0, 2 * Math.PI);
				ctx.fill();
				break;
			}
			requestAnimationFrame(draw);
		}

		const cvs = document.getElementById('cvs');
		const ctx = cvs.getContext('2d');

		const img = new MarvinImage();
		const imgEdge = new MarvinImage();
		const imgBlur = new MarvinImage();
		img.load("https://i.imgur.com/4b9R8R1.jpg", () => {
			cvs.setAttribute("width", img.width);
			cvs.setAttribute("height", img.height);

			imgEdge.setDimension(img.width, img.height);
			Marvin.prewitt(img, imgEdge);
			imgEdge.update();

			imgBlur.setDimension(img.width, img.height);
			imgBlur.ctx.filter = 'blur(5px) grayscale(100%)';
			imgBlur.ctx.drawImage(imgEdge.canvas, 0, 0);
			imgBlur.imageData = imgBlur.ctx.getImageData(0, 0, img.width, img.height);
			draw();
		});

	</script>
</body>
</html>