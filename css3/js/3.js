data={
        "8Track": [14.3,7.9,1.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0],
        "Cassette": [19.1,26.7,38.2,47.8,55.0,55.3,53.9,53.1,54.1,50.8,46.0,38.5,34.5,29.0,24.7,18.7,15.2,12.4,9.9,7.3,4.4,2.6,1.7,0.9,0.2,0.1,0.0,0.0,0.0,0.0,0.0],
        "CassetteSingle": [0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.3,0.9,3.0,3.4,2.9,3.3,3.0,2.3,1.9,1.5,1.1,0.7,0.3,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0],
        "CD": [0.0,0.0,0.0,0.5,2.4,8.9,20.0,28.6,33.4,39.3,45.8,55.5,59.2,64.8,70.1,76.1,79.2,81.1,84.5,87.9,92.2,94.0,95.3,94.7,92.7,85.6,79.7,70.0,62.4,55.6,49.1],
        "CDSingle": [0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.2,0.0,0.1,0.4,0.5,0.5,0.5,0.9,1.5,2.2,1.9,1.5,1.0,0.6,0.2,0.3,0.1,0.1,0.1,0.1,0.0,0.0,0.0],
        "DigitalPerformanceRoyalties": [0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.2,0.3,0.4,1.4,2.1,3.7],
        "DownloadAlbum": [0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.4,1.1,2.3,4.7,7.2,9.9,12.1],
        "DownloadMusicVideo": [0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.2,0.3,0.5,0.5,0.5],
        "DownloadSingle": [0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,1.1,3.0,4.9,7.6,11.8,15.9,20.0],
        "DVDAudio": [0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.1,0.1,0.1,0.1,0.0,0.0,0.0,0.0,0.0,0.0],
        "Kiosk": [0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.1,0.1],
        "LPEP": [59.8,58.9,53.0,44.6,35.7,29.4,21.2,14.3,8.5,3.3,1.1,0.4,0.1,0.1,0.1,0.2,0.3,0.3,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.1,0.1,0.2,0.6,0.8,1.3],
        "Mobile": [0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,3.4,6.6,9.9,11.1,9.5,7.7],
        "MusicVideo": [0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,1.8,2.3,1.5,1.7,2.1,1.9,1.8,1.9,2.6,2.6,2.6,2.0,2.4,2.3,3.4,4.9,4.9,3.9,4.6,2.5,2.8,2.6],
        "SACD": [0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.2,0.1,0.1,0.0,0.0,0.0,0.0,0.0],
        "Subscription": [0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,1.2,1.8,2.2,2.5,2.8,2.9],
        "VinylSingle": [6.8,6.5,7.8,7.1,6.9,6.4,4.9,3.7,2.9,1.8,1.3,0.8,0.7,0.5,0.4,0.4,0.4,0.3,0.2,0.2,0.2,0.2,0.2,0.2,0.2,0.1,0.1,0.0,0.0,0.0,0.0]
    };

$(document).ready(function() {
    assignColors();
    initializePie();

    var numYear = 30;
    var startYear = 1980
    var year = startYear;
    var slice = 0;
    $("#slideLabel").text( year )

    setTimeout( function(){
        new Dragdealer('year',
        {
            steps: numYear,
            snap: true,
            animationCallback: function(x, y){
                slice = Math.round(x*numYear);
                year = startYear + slice;
                $("#slideLabel").text( year ) ;
                updateData(slice);
            }       
        })},100);
});

function updateData(y){
    graph =  $("#graph");

    leg = $("#legend");
    leg.empty();

    var s = [];
    var angTot = 0;
    for (var k in data)
        if (data.hasOwnProperty(k)){
            s.push([k, data[k][y]]);
            angCur = Math.round(data[k][y]*36)/10;
            $("#"+k+"2").css('transform','rotate('+angTot+'deg)');
            if (data[k][y]>50){
                $("#"+k+"2>div").css('transform','rotate('+180+'deg)');
                angTot += 170;
                angCur -= 170;
            }
            else{
                $("#"+k+"2>div").css('transform','rotate(0deg)');
            }
            $("#"+k).css('transform','rotate('+angTot+'deg)');
            $("#"+k+">div").css('transform','rotate('+angCur+'deg)');
            angTot = Math.round((angTot+angCur)*10)/10;

        }

    s.sort(function(a, b) {return b[1] - a[1]});    
    for (var i=0; i<s.length; i++)
        if (s[i][1] != 0){
            leg.append("<div class='label'>"+ s[i][0] + " <span>"+ s[i][1].toFixed(1) +"</span></div>")
            $('#legend>div:last-child').css("border-left", color[s[i][0]] + " solid 1em");
        }
}

function initializePie(){
    var angTot = 0;
    var angCur = 21.2;
    graph = $("#graph");
    for (var k in data)
        if (data.hasOwnProperty(k)){
            graph.append("<div class='hold' id='"+k+"'></div>" );
            holder = $("#graph>div:last-child");
            holder.append("<div class='halfcircle'></div>");
            pie = $("#graph>div:last-child>div");

            holder.css('transform','rotate('+(angTot-1)+'deg)');
            pie.css('transform','rotate('+(angCur+1)+'deg)');
            pie.css('background-color',color[k]);
            angTot = Math.round((angTot+angCur)*10)/10;

            if (k=="CD" || k=="LPEP" || k=="Cassette"){
                graph.append("<div class='hold' id='"+k+"2'></div>" );
                holder = $("#graph>div:last-child");
                holder.append("<div class='halfcircle'></div>");
                pie = $("#graph>div:last-child>div");

                holder.css('transform','rotate(0deg)');
                pie.css('transform','rotate(0deg)');
                pie.css('background-color',color[k]);
            }
        }
}

var color = {};
function assignColors(){
    for (var k in data)
        if (data.hasOwnProperty(k))
            color[k] = genColor();
}

var GOLDEN_ANGLE = 137.5/360;
var angle = 0.0;
function genColor(){
    rgb = hslToRgb(angle,1,0.4);
    res = "rgb(" + rgb.join(',') + ")";
    angle = (angle + GOLDEN_ANGLE)%1;
    return res;
}

/**
 * Converts an HSL color value to RGB. Conversion formula
 * adapted from http://en.wikipedia.org/wiki/HSL_color_space.
 * Assumes h, s, and l are contained in the set [0, 1] and
 * returns r, g, and b in the set [0, 255].
 *
 * @param   Number  h       The hue
 * @param   Number  s       The saturation
 * @param   Number  l       The lightness
 * @return  Array           The RGB representation
 */
function hslToRgb(h, s, l){
    var r, g, b;

    if(s == 0){
        r = g = b = l; // achromatic
    }else{
        function hue2rgb(p, q, t){
            if(t < 0) t += 1;
            if(t > 1) t -= 1;
            if(t < 1/6) return p + (q - p) * 6 * t;
            if(t < 1/2) return q;
            if(t < 2/3) return p + (q - p) * (2/3 - t) * 6;
            return p;
        }

        var q = l < 0.5 ? l * (1 + s) : l + s - l * s;
        var p = 2 * l - q;
        r = hue2rgb(p, q, h + 1/3);
        g = hue2rgb(p, q, h);
        b = hue2rgb(p, q, h - 1/3);
    }

    return [ Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)];
}
